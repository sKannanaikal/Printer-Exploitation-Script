import os, sys, subprocess

printers = []

class Printer:

	def __init__(self, name, connection, connectiontype):
		self.name = name
		self.conntype = connectiontype
		self.connection = connection

def commandListing():
	print(
		'''
		help, scan, overlay, quit
		''')

def send(conntype, printer):
	if conntype == 'Physical':
		filepath = input('What file would you like to send: ')
		subprocess.run(["lpr", "-P", f"{printer.name}", f"{filepath}"])
		return
	else:
		print('[-] Printer Connection Error! Try again or Restart!')
		return

def scan():
	print('[+] Scanning for Printers!')
	currentsize = 0
	#physical printer scanning
	print('[+] Scanning for Physically Connected Printers')
	output = subprocess.check_output(["lpstat", "-p"])
	decoded = output.decode()
	results = decoded.split('\n')
	for result in results:
		if "enabled" in result:
			name = result.split(' ')[1]
			conntype = 'Physical'
			connection = ''
			printers.append(Printer(name, connection, conntype))

	if len(printers) == 0:
		print('[-] No Physically Connected Printers Found')
	else:
		currentsize = len(printers)

	'''
	#network printer scanning
	print('[+] Scanning for Printers Connected to the Network using SNMP')
	#DO SNMP Broadcast thingie here

	if len(printers) == 0 or len(printers) == currentsize:
		print('[-] No Printers found via SNMP')
	else:
		currentsize = len(printers)


	#full direct scan of network
	choice = input('[+] Would you like to scan entire network for devices listening on port 9100? (Y/N): ')
	if choice.upper == 'Y':
		#do full scan

	else:
		print('[+] Will not scan entire network')

	print('[+] Scan Complete!')

	if len(printers) == 0:
		print('[-] No printers found on network or physically connected!')
		return
	'''
	for printer in printers:
		print(printer.name)


def overlay():
	print('[+] Initiating Print Job Manipulation')
	data = None
	overlayfile = input('Path to Overlay File: ')
	if overlayfilepath.endswith('ps'):
		print('[+] Obtained Postscript file reading data!')
		#TODO: read file
		try:
			with open(overlayfilepath, 'rb') as file:
				data = file.read()
		except IOError as error:
			print('[-] Error when reading file!')
	else:
		print('[+] Obtained Nonpostscript file converting into usable postscript')

		#TODO: Format file into postscript format
	
	#TODO: send new configuration changes to printer so all future print jobs have the overlay present

def main():
	print(
			'''
			Welcome to PRES!
			''')
	commandListing()

	'''
	HIGH LEVEL OVERVIEW OF TASKS
	
	SCAN FOR PRINTERS AND CHOOSE TARGET
	SEND DATA TO PRINTER OVER USB(LINUX) AND NETWORK
	FIGURE OUT HOW TO DO DDOS ATTACK AND SEND IT OVER

	'''

	while True:
		command = input('$ ')
		
		if command == 'help':
			commandListing()
		elif command == 'scan':
			scan()
		elif command == 'overlay':
			overlay()
		elif command == 'quit':
			sys.exit(0)
		elif command == 'select':
			index = input('enter which index of a printer you would like: ')
			printer = printers[int(index)]
			send(printer.conntype, printer)
		else:
			print('[-] Command Not Recognized! Use help command to get listing of available commands!')
			print()

if __name__ == '__main__':
	main()